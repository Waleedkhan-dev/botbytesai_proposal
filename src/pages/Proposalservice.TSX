import { supabase } from "@/integrations/supabase/client";
export interface Proposal {
  id: number;
  created_at: string;
  "PROPOSAL DATA": string | null;
  STATUS: string | null;
  share_id: string | null;
  is_published: boolean;
  client_name: string | null;
  share_url: string | null;
}

export interface CreateProposalInput {
  proposalData: string;
  clientName?: string;
  status?: string;
}

/**
 * Generate the shareable URL for a proposal
 */
export const generateShareUrl = (shareId: string): string => {
  const baseUrl = window.location.origin;
  return `${baseUrl}/proposal/${shareId}`;
};

/**
 * Create a new proposal and return the shareable link
 */
export const createProposal = async (input: CreateProposalInput): Promise<{
  proposal: Proposal;
  shareUrl: string;
}> => {
  const { proposalData, clientName, status = "draft" } = input;

  // Insert the proposal - share_id is auto-generated by database
  const { data, error } = await supabase
    .from("PROPOSAL")
    .insert({
      "PROPOSAL DATA": proposalData,
      STATUS: status,
      client_name: clientName,
      is_published: false,
    })
    .select("*")
    .single();

  if (error) {
    console.error("❌ Error creating proposal:", error.message);
    throw new Error(error.message);
  }

  // Generate and update the share URL
  const shareUrl = generateShareUrl(data.share_id);
  
  const { data: updatedData, error: updateError } = await supabase
    .from("PROPOSAL")
    .update({ share_url: shareUrl })
    .eq("id", data.id)
    .select("*")
    .single();

  if (updateError) {
    console.error("❌ Error updating share URL:", updateError.message);
    throw new Error(updateError.message);
  }

  console.log("✅ Proposal created:", updatedData);
  return {
    proposal: updatedData as Proposal,
    shareUrl,
  };
};

/**
 * Create a copy of an existing proposal for a new client
 */
export const createProposalCopy = async (
  originalProposalId: number,
  clientName: string
): Promise<{
  proposal: Proposal;
  shareUrl: string;
}> => {
  // Fetch the original proposal
  const { data: original, error: fetchError } = await supabase
    .from("PROPOSAL")
    .select("*")
    .eq("id", originalProposalId)
    .single();

  if (fetchError || !original) {
    throw new Error("Original proposal not found");
  }

  // Create a new copy with a new share_id (auto-generated)
  const { data: copy, error: copyError } = await supabase
    .from("PROPOSAL")
    .insert({
      "PROPOSAL DATA": original["PROPOSAL DATA"],
      STATUS: "draft",
      client_name: clientName,
      is_published: false,
    })
    .select("*")
    .single();

  if (copyError) {
    throw new Error(copyError.message);
  }

  // Generate and update the share URL
  const shareUrl = generateShareUrl(copy.share_id);
  
  const { data: updatedCopy, error: updateError } = await supabase
    .from("PROPOSAL")
    .update({ share_url: shareUrl })
    .eq("id", copy.id)
    .select("*")
    .single();

  if (updateError) {
    throw new Error(updateError.message);
  }

  console.log("✅ Proposal copy created for client:", clientName);
  return {
    proposal: updatedCopy as Proposal,
    shareUrl,
  };
};

/**
 * Publish a proposal (make it viewable via share link)
 */
export const publishProposal = async (proposalId: number): Promise<Proposal> => {
  const { data, error } = await supabase
    .from("PROPOSAL")
    .update({ 
      is_published: true,
      STATUS: "published" 
    })
    .eq("id", proposalId)
    .select("*")
    .single();

  if (error) {
    throw new Error(error.message);
  }

  console.log("✅ Proposal published:", data);
  return data as Proposal;
};

/**
 * Fetch proposal by share_id (for public viewing)
 */
export const getProposalByShareId = async (shareId: string): Promise<Proposal | null> => {
  const { data, error } = await supabase
    .from("PROPOSAL")
    .select("*")
    .eq("share_id", shareId)
    .single();

  if (error) {
    console.error("❌ Error fetching proposal:", error.message);
    return null;
  }

  return data as Proposal;
};

/**
 * Fetch proposal by ID (for internal use)
 */
export const getProposalById = async (id: number): Promise<Proposal | null> => {
  const { data, error } = await supabase
    .from("PROPOSAL")
    .select("*")
    .eq("id", id)
    .single();

  if (error) {
    console.error("❌ Error fetching proposal:", error.message);
    return null;
  }

  return data as Proposal;
};

/**
 * Update proposal data
 */
export const updateProposal = async (
  proposalId: number,
  proposalData: string
): Promise<Proposal> => {
  const { data, error } = await supabase
    .from("PROPOSAL")
    .update({ "PROPOSAL DATA": proposalData })
    .eq("id", proposalId)
    .select("*")
    .single();

  if (error) {
    throw new Error(error.message);
  }

  return data as Proposal;
};

/**
 * Get all proposals (for admin/dashboard)
 */
export const getAllProposals = async (): Promise<Proposal[]> => {
  const { data, error } = await supabase
    .from("PROPOSAL")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    throw new Error(error.message);
  }

  return data as Proposal[];
};